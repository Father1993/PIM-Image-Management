# Описание структуры JSON файла catalog_tree_with_products.json

## Для программиста 1С

Этот документ описывает структуру JSON файла, который содержит полное дерево каталога с привязанными товарами из системы PIM.

---

## Корневая структура файла

```json
{
  "generated_at": "...",      // Дата и время создания файла
  "source": "...",             // Источник данных
  "catalog_id": 21,            // ID основного каталога
  "statistics": {...},         // Статистика по каталогам и товарам
  "tree": {...}                // Дерево каталогов с товарами
}
```

---

## Описание полей корневого уровня

| Поле | Тип | Описание |
|------|-----|----------|
| `generated_at` | Строка (ISO 8601) | Дата и время создания файла в формате UTC. Пример: `"2026-02-03T23:22:36.134544Z"` |
| `source` | Строка | Источник данных. Всегда: `"COMPO PIM API"` |
| `catalog_id` | Число | Идентификатор основного каталога (в данном случае 21 = "Uroven.pro") |
| `statistics` | Объект | Сводная статистика по всему дереву (см. ниже) |
| `tree` | Объект | Корневой элемент дерева каталогов с товарами (см. ниже) |

---

## Объект `statistics` (Статистика)

```json
{
  "total_catalogs": 1251,           // Всего каталогов в дереве
  "catalogs_with_products": 1087,   // Каталогов, в которых есть товары
  "leaf_catalogs": 1129,            // Конечных каталогов (без подкатегорий)
  "total_products": 46688,          // Всего уникальных товаров
  "max_depth": 2                    // Максимальная глубина вложенности
}
```

| Поле | Тип | Описание |
|------|-----|----------|
| `total_catalogs` | Число | Общее количество всех каталогов (категорий) в дереве, включая вложенные |
| `catalogs_with_products` | Число | Количество каталогов, в которых есть хотя бы один товар |
| `leaf_catalogs` | Число | Количество конечных каталогов (без подкатегорий) |
| `total_products` | Число | Общее количество уникальных товаров во всем дереве |
| `max_depth` | Число | Максимальный уровень вложенности каталогов (начинается с 2) |

---

## Объект `tree` (Дерево каталогов)

Каждый элемент дерева представляет собой **каталог (категорию)** со следующей структурой:

```json
{
  "id": 21,                          // ID каталога
  "header": "Uroven.pro",            // Название каталога
  "syncUid": "9db1eab4-...",        // Уникальный идентификатор для синхронизации
  "parentId": 1,                     // ID родительского каталога
  "level": 2,                        // Уровень вложенности
  "lastLevel": false,                // Является ли конечным каталогом
  "enabled": true,                   // Активен ли каталог
  "deleted": false,                  // Удален ли каталог
  "productCountPim": 1,              // Количество товаров по счетчику PIM
  "lft": 2,                          // Левое значение для дерева (Nested Set)
  "rgt": 2503,                       // Правое значение для дерева (Nested Set)
  "products": [...],                 // Массив товаров в этом каталоге
  "products_count": 0,               // Фактическое количество товаров в массиве
  "children": [...]                  // Массив подкаталогов (вложенные категории)
}
```

### Поля каталога (категории)

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Число | **Уникальный идентификатор каталога** в системе PIM. Используется для связи с товарами |
| `header` | Строка | **Название каталога** (категории). Например: "Отопление", "Сопутствующий товар для труб" |
| `syncUid` | Строка (UUID) | **Уникальный идентификатор для синхронизации** между системами. Формат UUID (36 символов) |
| `parentId` | Число или null | **ID родительского каталога**. Если `null` или `1` - это корневой уровень |
| `level` | Число | **Уровень вложенности** в дереве. Начинается с 2 (корень = 1, но не включается) |
| `lastLevel` | Булево | **Конечный каталог** - `true` если у каталога нет подкатегорий (`children` пустой) |
| `enabled` | Булево | **Активность каталога** - `true` если каталог активен и используется |
| `deleted` | Булево | **Признак удаления** - `true` если каталог удален (нормально должно быть `false`) |
| `productCountPim` | Число | **Количество товаров по счетчику** из системы PIM (может отличаться от фактического) |
| `lft` | Число | **Левое значение** для алгоритма Nested Set (используется для быстрого поиска поддерева) |
| `rgt` | Число | **Правое значение** для алгоритма Nested Set |
| `products` | Массив | **Массив товаров**, привязанных к этому каталогу (см. описание товара ниже) |
| `products_count` | Число | **Фактическое количество товаров** в массиве `products` |
| `children` | Массив | **Массив подкаталогов** (вложенные категории). Структура рекурсивная - каждый элемент имеет такую же структуру |

---

## Объект товара в массиве `products`

Каждый товар в массиве `products` имеет следующую структуру:

```json
{
  "id": 28729,                                    // ID товара
  "header": "Гель Сантехмастер Зеленый...",      // Название товара
  "articul": "55037",                             // Артикул товара
  "sync_uid": "baecf3ff-1bf4-440c-...",          // Уникальный идентификатор товара
  "enabled": true,                                // Активен ли товар
  "is_primary": false                             // Основная категория или дополнительная
}
```

### Поля товара

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | Число | **Уникальный идентификатор товара** в системе PIM. Основной ключ для связи |
| `header` | Строка | **Название товара** (полное наименование) |
| `articul` | Строка | **Артикул товара** - уникальный код товара от производителя/поставщика |
| `sync_uid` | Строка (UUID) | **Уникальный идентификатор для синхронизации** между системами. Формат UUID |
| `enabled` | Булево | **Активность товара** - `true` если товар активен и доступен для продажи |
| `is_primary` | Булево | **Основная категория** - `true` если это основная категория товара, `false` если дополнительная (товар может быть в нескольких категориях) |

---

## Важные особенности структуры

### 1. Рекурсивная структура дерева
Дерево каталогов имеет **рекурсивную структуру** - каждый каталог может содержать вложенные каталоги в поле `children`. Для обхода дерева в 1С используйте рекурсивную функцию.

### 2. Товары могут быть в нескольких каталогах
Один товар может быть привязан к **нескольким каталогам** одновременно:
- В **одном** каталоге товар будет с `is_primary: true` (основная категория)
- В **других** каталогах тот же товар будет с `is_primary: false` (дополнительные категории)

### 3. Пустые массивы
- Если у каталога нет товаров, массив `products` будет пустым `[]`
- Если у каталога нет подкатегорий, массив `children` будет пустым `[]`

### 4. Nested Set (lft, rgt)
Поля `lft` и `rgt` используются для алгоритма Nested Set:
- Все потомки каталога имеют `lft` между `lft` и `rgt` родителя
- Можно быстро найти все подкаталоги: `WHERE lft > parent.lft AND rgt < parent.rgt`

---

## Пример использования в 1С

### Обход дерева каталогов (рекурсивно)

```bsl
Процедура ОбойтиДеревоКаталогов(УзелДерева, Уровень = 0)
    
    // Обработка текущего каталога
    Сообщить(Строка(Уровень) + ": " + УзелДерева.Заголовок);
    
    // Обработка товаров в каталоге
    Для Каждого Товар Из УзелДерева.Товары Цикл
        Сообщить("  Товар: " + Товар.Заголовок + " (Артикул: " + Товар.Артикул + ")");
    КонецЦикла;
    
    // Рекурсивный обход подкаталогов
    Для Каждого Подкаталог Из УзелДерева.Дети Цикл
        ОбойтиДеревоКаталогов(Подкаталог, Уровень + 1);
    КонецЦикла;
    
КонецПроцедуры
```

### Поиск товара по артикулу

```bsl
Функция НайтиТоварПоАртикулу(УзелДерева, ИскомыйАртикул)
    
    // Поиск в товарах текущего каталога
    Для Каждого Товар Из УзелДерева.Товары Цикл
        Если Товар.Артикул = ИскомыйАртикул Тогда
            Возврат Товар;
        КонецЕсли;
    КонецЦикла;
    
    // Поиск в подкаталогах
    Для Каждого Подкаталог Из УзелДерева.Дети Цикл
        Результат = НайтиТоварПоАртикулу(Подкаталог, ИскомыйАртикул);
        Если Результат <> Неопределено Тогда
            Возврат Результат;
        КонецЕсли;
    КонецЦикла;
    
    Возврат Неопределено;
    
КонецФункции
```

### Построение плоского списка всех товаров

```bsl
Процедура ПолучитьВсеТовары(УзелДерева, МассивТоваров)
    
    // Добавляем товары текущего каталога
    Для Каждого Товар Из УзелДерева.Товары Цикл
        ТоварСКатегорией = Новый Структура;
        ТоварСКатегорией.Вставить("Товар", Товар);
        ТоварСКатегорией.Вставить("КатегорияID", УзелДерева.ID);
        ТоварСКатегорией.Вставить("КатегорияНазвание", УзелДерева.Заголовок);
        МассивТоваров.Добавить(ТоварСКатегорией);
    КонецЦикла;
    
    // Обрабатываем подкаталоги
    Для Каждого Подкаталог Из УзелДерева.Дети Цикл
        ПолучитьВсеТовары(Подкаталог, МассивТоваров);
    КонецЦикла;
    
КонецПроцедуры
```

---

## Соответствие полей с типичными структурами 1С

| Поле JSON | Тип в 1С | Рекомендуемое имя в 1С |
|-----------|----------|------------------------|
| `id` | Число | `Идентификатор` или `Код` |
| `header` | Строка | `Наименование` или `Заголовок` |
| `syncUid` / `sync_uid` | Строка | `УникальныйИдентификатор` или `ИдентификаторСинхронизации` |
| `parentId` | Число | `Родитель` или `РодительскийКаталог` |
| `level` | Число | `Уровень` |
| `lastLevel` | Булево | `Конечный` или `БезПодкатегорий` |
| `enabled` | Булево | `Активен` или `ПометкаУдаления = Ложь` |
| `deleted` | Булево | `Удален` или `ПометкаУдаления` |
| `articul` | Строка | `Артикул` |
| `is_primary` | Булево | `ОсновнаяКатегория` |
| `products` | Массив | `Товары` |
| `children` | Массив | `Подкаталоги` или `Дети` |
| `products_count` | Число | `КоличествоТоваров` |

---

## Примечания для программиста 1С

1. **Формат даты**: `generated_at` в формате ISO 8601. В 1С используйте `ДатаВремя()` с парсингом строки.

2. **UUID**: Поля `syncUid` и `sync_uid` содержат UUID в формате строки. Можно использовать для уникальной идентификации при синхронизации.

3. **Рекурсия**: Для обхода дерева обязательно используйте рекурсивные функции, так как глубина вложенности может быть любой.

4. **Производительность**: Если нужно найти все товары, лучше один раз обойти дерево и построить плоский список, чем искать каждый раз рекурсивно.

5. **Дубликаты товаров**: Один товар может встречаться в нескольких каталогах. Если нужны уникальные товары, используйте `id` или `sync_uid` для дедупликации.

---

## Версия документа

Документ создан: 2026-02-03  
Версия структуры JSON: 1.0  
Источник данных: COMPO PIM API
