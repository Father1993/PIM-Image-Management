# –≠–∫—Å–ø–æ—Ä—Ç –∏ —Ä–∞–±–æ—Ç–∞ —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π –∫–∞—Ç–∞–ª–æ–≥–æ–≤ COMPO PIM

–ü–æ–ª–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —ç–∫—Å–ø–æ—Ä—Ç—É —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∏–∑ COMPO PIM –∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤ Supabase –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–π –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ

1. [–û–±–∑–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–∞](#–æ–±–∑–æ—Ä-—Å—Ç—Ä—É–∫—Ç—É—Ä—ã-–∫–∞—Ç–∞–ª–æ–≥–∞)
2. [–°–∫—Ä–∏–ø—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞](#—Å–∫—Ä–∏–ø—Ç—ã-—ç–∫—Å–ø–æ—Ä—Ç–∞)
3. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-–¥–∞–Ω–Ω—ã—Ö)
4. [–ó–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase](#–∑–∞–≥—Ä—É–∑–∫–∞-–≤-supabase)
5. [–†–∞–±–æ—Ç–∞ —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π](#—Ä–∞–±–æ—Ç–∞-—Å-–∏–µ—Ä–∞—Ä—Ö–∏–µ–π)
6. [–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è](#–ø—Ä–∏–º–µ—Ä—ã-–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è)

---

## –û–±–∑–æ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ COMPO PIM

COMPO PIM –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **Nested Sets** (–≤–ª–æ–∂–µ–Ω–Ω—ã–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞) –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫–∞—Ç–∞–ª–æ–≥–æ–≤. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç:

- –ë—ã—Å—Ç—Ä–æ –ø–æ–ª—É—á–∞—Ç—å –≤—Å–µ –ø–æ—Ç–æ–º–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞
- –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ —Å—Ç—Ä–æ–∏—Ç—å –ø—É—Ç–∏ –≤ –¥–µ—Ä–µ–≤–µ
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å –∫ –≤–µ—Ç–∫–µ
- –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –≤ –≤–µ—Ç–∫–µ

#### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è:

| –ü–æ–ª–µ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|-----|----------|
| `id` | Integer | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä |
| `header` | String | –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ |
| `syncUid` | UUID | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ |
| `parentId` | Integer | ID —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–∞—Ç–∞–ª–æ–≥–∞ |
| `lft` | Integer | –õ–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ (Nested Sets) |
| `rgt` | Integer | –ü—Ä–∞–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ (Nested Sets) |
| `level` | Integer | –£—Ä–æ–≤–µ–Ω—å –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç–∏ (1, 2, 3...) |
| `lastLevel` | Boolean | –ö–æ–Ω–µ—á–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å (–º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–≤–∞—Ä—ã) |
| `productCountPim` | Integer | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ |

### –ü—Ä–∏–º–µ—Ä —Å—Ç—Ä—É–∫—Ç—É—Ä—ã:

```
–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ (id: 1, lft: 1, rgt: 10, level: 1)
‚îú‚îÄ‚îÄ –ö–æ–º–ø—å—é—Ç–µ—Ä—ã (id: 2, lft: 2, rgt: 5, level: 2)
‚îÇ   ‚îú‚îÄ‚îÄ –ù–æ—É—Ç–±—É–∫–∏ (id: 3, lft: 3, rgt: 4, level: 3, lastLevel: true)
‚îú‚îÄ‚îÄ –¢–µ–ª–µ—Ñ–æ–Ω—ã (id: 4, lft: 6, rgt: 9, level: 2)
‚îÇ   ‚îú‚îÄ‚îÄ –°–º–∞—Ä—Ç—Ñ–æ–Ω—ã (id: 5, lft: 7, rgt: 8, level: 3, lastLevel: true)
```

---

## –°–∫—Ä–∏–ø—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∞

### 1. `export_catalog_structure.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –≠–∫—Å–ø–æ—Ä—Ç –ø–æ–ª–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤ –∏–∑ PIM –≤ JSON.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª–Ω–æ–µ –¥–µ—Ä–µ–≤–æ –∫–∞—Ç–∞–ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ API `/api/v1/catalog`
- –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ–±—Ö–æ–¥–∏—Ç –¥–µ—Ä–µ–≤–æ –∏ —Å–æ–∑–¥–∞–µ—Ç –ø–ª–æ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, –ø—É—Ç–∏, —Å—á–µ—Ç—á–∏–∫–∏
- –°—Ç—Ä–æ–∏—Ç –∫–∞—Ä—Ç—É –∏–µ—Ä–∞—Ä—Ö–∏–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- –í—ã—á–∏—Å–ª—è–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ .env
PIM_API_URL=https://your-pim.compo-soft.ru
PIM_LOGIN=your_login
PIM_PASSWORD=your_password
PIM_CATALOG_OUTPUT=data/catalog_structure.json

# –ó–∞–ø—É—Å–∫
python export/export_catalog_structure.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

–§–∞–π–ª `data/catalog_structure.json` —Å–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π:

```json
{
  "generated_at": "2024-12-22T10:30:00Z",
  "source": "COMPO PIM API",
  "statistics": {
    "total_catalogs": 450,
    "enabled_catalogs": 420,
    "leaf_catalogs": 180,
    "max_depth": 5,
    "total_products": 15000
  },
  "catalogs": [
    {
      "id": 1,
      "header": "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞",
      "syncUid": "uuid-here",
      "parentId": null,
      "level": 1,
      "path": "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞",
      "pathArray": ["–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞"],
      "depth": 1,
      "hasChildren": true,
      "childrenCount": 3,
      "lastLevel": false,
      "productCountPim": 5000,
      "lft": 1,
      "rgt": 100
    }
  ],
  "hierarchy_map": {
    "1": {
      "children_ids": [2, 4, 6],
      "parent_id": null
    }
  }
}
```

### 2. `export_product_catalog_links.py`

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –≠–∫—Å–ø–æ—Ä—Ç —Å–≤—è–∑–µ–π —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫–∞—Ç–∞–ª–æ–≥–∞–º–∏.

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
- –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ —Ç–æ–≤–∞—Ä—ã —á–µ—Ä–µ–∑ scroll API
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏
- –°–æ–∑–¥–∞–µ—Ç —Å–≤—è–∑–∏ `product_id` ‚Üî `catalog_id`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–∏–ø–µ —Å–≤—è–∑–∏ (–æ—Å–Ω–æ–≤–Ω–∞—è/–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ .env
PIM_PRODUCT_CATALOG=21  # ID –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
PIM_PRODUCT_CATALOG_OUTPUT=data/product_catalog_links.json
PIM_PRODUCT_CONCURRENCY=50  # –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

# –ó–∞–ø—É—Å–∫
python export/export_product_catalog_links.py
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

```json
{
  "generated_at": "2024-12-22T10:45:00Z",
  "catalog_id": 21,
  "statistics": {
    "total_products": 15000,
    "total_links": 18500,
    "primary_links": 15000,
    "additional_links": 3500,
    "unique_catalogs": 180
  },
  "links": [
    {
      "product_id": 12345,
      "catalog_id": 100,
      "catalog_sync_uid": "uuid",
      "catalog_header": "–ù–æ—É—Ç–±—É–∫–∏",
      "is_primary": true,
      "sort_order": 0
    }
  ],
  "products": [...]
}
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### –ü–ª–æ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç –∫–∞—Ç–∞–ª–æ–≥–∞

–ö–∞–∂–¥—ã–π –∫–∞—Ç–∞–ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç:

```typescript
interface Catalog {
  // –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
  id: number;
  header: string;
  syncUid: string;
  
  // –ò–µ—Ä–∞—Ä—Ö–∏—è
  parentId: number | null;
  level: number;
  lft: number;
  rgt: number;
  lastLevel: boolean;
  
  // –ü—É—Ç—å
  path: string;              // "–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞ > –ö–æ–º–ø—å—é—Ç–µ—Ä—ã > –ù–æ—É—Ç–±—É–∫–∏"
  pathArray: string[];       // ["–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞", "–ö–æ–º–ø—å—é—Ç–µ—Ä—ã", "–ù–æ—É—Ç–±—É–∫–∏"]
  depth: number;             // 3
  
  // –î–µ—Ç–∏
  hasChildren: boolean;
  childrenCount: number;
  
  // –¢–æ–≤–∞—Ä—ã
  productCount: number;
  productCountPim: number;
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ
  enabled: boolean;
  deleted: boolean;
  pos: number;
  
  // SEO
  htHead: string;
  htDesc: string;
  htKeywords: string;
  content: string;
  
  // –í—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏
  createdAt: string;
  updatedAt: string;
}
```

### –°–≤—è–∑–∏ —Ç–æ–≤–∞—Ä–æ–≤ —Å –∫–∞—Ç–∞–ª–æ–≥–∞–º–∏

```typescript
interface ProductCatalogLink {
  product_id: number;
  catalog_id: number;
  catalog_sync_uid: string;
  catalog_header: string;
  is_primary: boolean;     // –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è
  sort_order: number;      // –ü–æ—Ä—è–¥–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
}
```

---

## –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase

### –®–∞–≥ 1: –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü

```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
psql -h your-supabase.supabase.co \
     -U postgres \
     -d postgres \
     -f export/supabase_catalog_schema.sql
```

–ò–ª–∏ —á–µ—Ä–µ–∑ Supabase Dashboard:
1. –û—Ç–∫—Ä—ã—Ç—å SQL Editor
2. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ `supabase_catalog_schema.sql`
3. –í—ã–ø–æ–ª–Ω–∏—Ç—å

### –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤

```bash
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ .env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key

# –ó–∞–ø—É—Å–∫ –∑–∞–≥—Ä—É–∑–∫–∏
python export/load_catalog_to_supabase.py
```

–°–∫—Ä–∏–ø—Ç —Å–ø—Ä–æ—Å–∏—Ç:
- –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ? (y/N)

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç:
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤
- –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —É—Ä–æ–≤–Ω—è–º
- –ê–∫—Ç–∏–≤–Ω—ã–µ/–∫–æ–Ω–µ—á–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏

### –®–∞–≥ 3: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–≤—è–∑–µ–π —Ç–æ–≤–∞—Ä–æ–≤

```bash
python export/load_product_catalog_links_to_supabase.py
```

–°–∫—Ä–∏–ø—Ç —Å–ø—Ä–æ—Å–∏—Ç:
- –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–≤—è–∑–∏? (y/N)
- –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤? (Y/n)

---

## –†–∞–±–æ—Ç–∞ —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π

### –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤ –∫–∞—Ç–∞–ª–æ–≥–∞

```sql
-- –ò—Å–ø–æ–ª—å–∑—É—è Nested Sets (–±—ã—Å—Ç—Ä—ã–π —Å–ø–æ—Å–æ–±)
SELECT *
FROM catalogs c2
WHERE c2.lft > (SELECT lft FROM catalogs WHERE id = 1)
  AND c2.rgt < (SELECT rgt FROM catalogs WHERE id = 1)
ORDER BY c2.lft;

-- –ò–ª–∏ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é
SELECT * FROM get_catalog_descendants(1);
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É—Ç–∏ –¥–æ –∫–æ—Ä–Ω—è

```sql
-- –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE
WITH RECURSIVE ancestors AS (
  SELECT id, header, level, parent_id
  FROM catalogs
  WHERE id = 100
  
  UNION ALL
  
  SELECT c.id, c.header, c.level, c.parent_id
  FROM catalogs c
  INNER JOIN ancestors a ON c.id = a.parent_id
)
SELECT * FROM ancestors ORDER BY level;

-- –ò–ª–∏ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é
SELECT * FROM get_catalog_ancestors(100);
```

### –ü–æ–¥—Å—á–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –≤–µ—Ç–∫–µ

```sql
-- –í–∫–ª—é—á–∞—è –≤—Å–µ –ø–æ–¥–∫–∞—Ç–∞–ª–æ–≥–∏
SELECT count_products_in_branch(1);

-- –ò–ª–∏ —á–µ—Ä–µ–∑ JOIN
SELECT COUNT(DISTINCT pc.product_id)
FROM product_catalogs pc
INNER JOIN catalogs c ON pc.catalog_id = c.id
WHERE c.lft >= (SELECT lft FROM catalogs WHERE id = 1)
  AND c.rgt <= (SELECT rgt FROM catalogs WHERE id = 1);
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

```sql
-- –¢–æ–ª—å–∫–æ –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
SELECT p.*
FROM products p
INNER JOIN product_catalogs pc ON p.id = pc.product_id
WHERE pc.catalog_id = 100;

-- –ò–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –≤—Å–µ—Ö –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
SELECT DISTINCT p.*
FROM products p
INNER JOIN product_catalogs pc ON p.id = pc.product_id
INNER JOIN catalogs c ON pc.catalog_id = c.id
WHERE c.lft >= (SELECT lft FROM catalogs WHERE id = 100)
  AND c.rgt <= (SELECT rgt FROM catalogs WHERE id = 100);
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### Python: –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤

```python
import json

def build_tree(catalogs: list[dict]) -> dict:
    """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–µ—Ä–µ–≤–∞ –∏–∑ –ø–ª–æ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∫–∞."""
    catalog_map = {c["id"]: {**c, "children": []} for c in catalogs}
    root = {"children": []}
    
    for catalog in catalog_map.values():
        parent_id = catalog.get("parentId")
        if parent_id and parent_id in catalog_map:
            catalog_map[parent_id]["children"].append(catalog)
        else:
            root["children"].append(catalog)
    
    return root

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
with open("data/catalog_structure.json") as f:
    data = json.load(f)

tree = build_tree(data["catalogs"])
```

### Python: –ü–æ–∏—Å–∫ –ø–æ –ø—É—Ç–∏

```python
def find_by_path(catalogs: list[dict], path_parts: list[str]) -> dict | None:
    """–ü–æ–∏—Å–∫ –∫–∞—Ç–∞–ª–æ–≥–∞ –ø–æ –º–∞—Å—Å–∏–≤—É –ø—É—Ç–∏."""
    for catalog in catalogs:
        if catalog["pathArray"] == path_parts:
            return catalog
    return None

# –ü—Ä–∏–º–µ—Ä
catalog = find_by_path(
    data["catalogs"],
    ["–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞", "–ö–æ–º–ø—å—é—Ç–µ—Ä—ã", "–ù–æ—É—Ç–±—É–∫–∏"]
)
```

### JavaScript: –†–µ–Ω–¥–µ—Ä –¥–µ—Ä–µ–≤–∞

```javascript
function renderCatalogTree(catalogs, parentId = null, level = 0) {
  return catalogs
    .filter(c => c.parentId === parentId)
    .map(catalog => ({
      ...catalog,
      level,
      children: renderCatalogTree(catalogs, catalog.id, level + 1)
    }));
}

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ React
function CatalogTree({ catalogs }) {
  const tree = renderCatalogTree(catalogs);
  
  return (
    <ul>
      {tree.map(catalog => (
        <li key={catalog.id}>
          {catalog.header}
          {catalog.children.length > 0 && (
            <CatalogTree catalogs={catalog.children} />
          )}
        </li>
      ))}
    </ul>
  );
}
```

### SQL: –ü—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∫–∏

```sql
-- –ö–∞—Ç–∞–ª–æ–≥–∏ —Å breadcrumbs
CREATE VIEW v_catalogs_with_breadcrumbs AS
SELECT 
  c.id,
  c.header,
  c.path,
  array_to_string(c.path_array, ' > ') as breadcrumb,
  c.level,
  c.product_count_pim,
  c.enabled
FROM catalogs c
WHERE c.deleted = FALSE;

-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (—Ç–æ–ø-20 –ø–æ —Ç–æ–≤–∞—Ä–∞–º)
CREATE VIEW v_popular_catalogs AS
SELECT 
  c.id,
  c.header,
  c.path,
  c.product_count_pim,
  c.last_level
FROM catalogs c
WHERE c.enabled = TRUE 
  AND c.deleted = FALSE
  AND c.product_count_pim > 0
ORDER BY c.product_count_pim DESC
LIMIT 20;
```

---

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è

### Cron –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

```bash
# crontab -e

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
0 3 * * * cd /path/to/project && python export/export_catalog_structure.py && python export/load_catalog_to_supabase.py

# –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 4:00 - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–µ–π —Ç–æ–≤–∞—Ä–æ–≤
0 4 * * * cd /path/to/project && python export/export_product_catalog_links.py && python export/load_product_catalog_links_to_supabase.py
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

```python
# –ü—Ä–∏–º–µ—Ä –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
def sync_catalog_changes(last_sync: datetime):
    """–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö –∫–∞—Ç–∞–ª–æ–≥–æ–≤."""
    # –ü–æ–ª—É—á–∏—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∏, –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ –ø–æ—Å–ª–µ last_sync
    catalogs = fetch_updated_catalogs(last_sync)
    
    # –û–±–Ω–æ–≤–∏—Ç—å –≤ Supabase
    for catalog in catalogs:
        supabase.table("catalogs").upsert(catalog).execute()
```

---

## Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –û—à–∏–±–∫–∞ "Foreign key constraint"

**–†–µ—à–µ–Ω–∏–µ:** –ó–∞–≥—Ä—É–∂–∞–π—Ç–µ –∫–∞—Ç–∞–ª–æ–≥–∏ –≤ –ø–æ—Ä—è–¥–∫–µ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—è `level`:

```python
catalogs_sorted = sorted(catalogs, key=lambda x: x["level"])
```

### –ü—Ä–æ–±–ª–µ–º–∞: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–≤—è–∑–µ–π

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `UPSERT` —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–Ω—ã–º –∫–ª—é—á–æ–º:

```python
supabase.table("product_catalogs").upsert(
    links,
    on_conflict="product_id,catalog_id"
).execute()
```

### –ü—Ä–æ–±–ª–µ–º–∞: –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω–¥–µ–∫—Å—ã:

```sql
-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã
\d+ catalogs
\d+ product_catalogs

-- –ê–Ω–∞–ª–∏–∑ –ø–ª–∞–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞
EXPLAIN ANALYZE
SELECT * FROM catalogs WHERE lft > 10 AND rgt < 100;
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–∞—Ç–∞–ª–æ–≥–æ–≤
2. ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ Supabase
3. ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
4. üîÑ –°–æ–∑–¥–∞–Ω–∏–µ API –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
5. üîÑ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ UI –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–∞–ª–æ–≥–∞–º–∏
6. üîÑ –†–µ–∞–ª–∏–∑–∞—Ü–∏—è drag-and-drop –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
7. üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –æ–±—Ä–∞—Ç–Ω–æ –≤ PIM

---

## –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [Nested Sets –≤ PostgreSQL](https://www.postgresql.org/docs/current/queries-with.html)
- [Supabase Documentation](https://supabase.com/docs)
- [COMPO PIM API](../docs/API-COMPO-PIM.md)

