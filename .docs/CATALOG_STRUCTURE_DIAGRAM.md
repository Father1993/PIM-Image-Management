# 📊 Диаграмма структуры каталогов

## Архитектура данных

```
┌─────────────────────────────────────────┐
│         ТАБЛИЦА: products               │
│  (47,131 товаров)                       │
│                                         │
│  • id (BIGINT) ← ID из PIM!             │
│  • product_name                         │
│  • description                          │
│  • article                              │
│  • ...                                  │
└──────────────┬──────────────────────────┘
               │
               │ Связь: products.id = product_catalogs.product_id
               │
┌──────────────▼──────────────────────────┐
│   ТАБЛИЦА: product_catalogs             │
│   (многие ко многим)                    │
│                                         │
│  • product_id (BIGINT) ← products.id    │
│  • catalog_id (BIGINT)                  │
│  • is_primary (BOOLEAN)                 │
│  • sort_order (INTEGER)                 │
└──────────────┬──────────────────────────┘
               │
               │ Связь: product_catalogs.catalog_id = catalogs.id
               │
┌──────────────▼──────────────────────────┐
│         ТАБЛИЦА: catalogs               │
│  (2,587 категорий)                      │
│                                         │
│  • id (BIGINT)                          │
│  • header (TEXT)                        │
│  • parent_id (BIGINT) ← self-reference  │
│  • lft, rgt (INTEGER) ← Nested Sets     │
│  • path (TEXT)                          │
│  • path_array (TEXT[])                  │
│  • ...                                  │
└─────────────────────────────────────────┘
```

---

## Иерархия каталогов

```
ROOT (id=1)
├── Уровень - 1с (id=X)
│   ├── Инструмент
│   │   ├── Электроинструмент
│   │   │   ├── Перфораторы
│   │   │   └── Дрели
│   │   └── Ручной инструмент
│   └── Крепеж
│       ├── Саморезы
│       └── Болты
│
├── Uroven.pro (id=21)
│   ├── Инструмент (маркетплейс)
│   │   ├── Электроинструмент
│   │   └── Садовый инструмент
│   └── Крепеж
│
├── Uroven.store (id=633)
│   └── ...
│
└── Мастер каталог (id=19)
    └── ...
```

---

## Пример: Товар в нескольких каталогах

```
Товар: "Перфоратор AEG" (id=119 в products)

┌─────────────────────────────────────────┐
│  products.id = 119                      │
│  product_name = "Перфоратор AEG..."     │
│  article = "15600525"                   │
└──────────────┬──────────────────────────┘
               │
               ├─────────────────────────────┐
               │                             │
┌──────────────▼───────┐    ┌───────────────▼──────┐
│ product_catalogs     │    │ product_catalogs     │
│                      │    │                      │
│ product_id: 119      │    │ product_id: 119      │
│ catalog_id: 1027     │    │ catalog_id: 826      │
│ is_primary: TRUE ✓   │    │ is_primary: FALSE    │
│ sort_order: 0        │    │ sort_order: 1        │
└──────────┬───────────┘    └──────────┬───────────┘
           │                           │
           │                           │
┌──────────▼───────────┐    ┌──────────▼───────────┐
│ catalogs             │    │ catalogs             │
│                      │    │                      │
│ id: 1027             │    │ id: 826              │
│ header: "Перфораторы"│    │ header: "Категория 1"│
│ parent_id: X         │    │ parent_id: 21        │
│ path: "1С > Инстру...│    │ path: "Uroven.pro >..│
└──────────────────────┘    └──────────────────────┘
     ↑                           ↑
     │                           │
 Уровень - 1с              Uroven.pro
 (основная)                (дополнительная)
```

---

## Nested Sets визуализация

```
Категория "Инструмент" (lft=10, rgt=50)
│
├── "Электроинструмент" (lft=11, rgt=30)
│   │
│   ├── "Перфораторы" (lft=12, rgt=20)
│   │   ├── "AEG" (lft=13, rgt=14)
│   │   ├── "Makita" (lft=15, rgt=16)
│   │   └── "Bosch" (lft=17, rgt=18)
│   │
│   └── "Дрели" (lft=21, rgt=29)
│       ├── "Аккумуляторные" (lft=22, rgt=23)
│       └── "Сетевые" (lft=24, rgt=25)
│
└── "Ручной инструмент" (lft=31, rgt=49)
    ├── "Отвертки" (lft=32, rgt=33)
    └── "Молотки" (lft=34, rgt=35)
```

**Правило:** Все потомки имеют `lft > parent.lft AND rgt < parent.rgt`

---

## Типы каталогов

### 1. **Уровень - 1с**
- **Назначение:** Прием новых товаров из 1С
- **Товаров:** ~46,951
- **Статус:** Необработанные
- **Действие:** Менеджеры разбирают → перемещают в Uroven.pro

### 2. **Uroven.pro**
- **Назначение:** Готовые товары для выгрузки на сайт
- **Товаров:** ~28,684
- **Статус:** Обработанные
- **Действие:** Экспорт на сайт с правильной иерархией

### 3. **Мастер каталог**
- **Назначение:** Тестовые/специальные товары
- **Товаров:** ~2
- **Статус:** Системный

### 4. **Uroven.store**
- **Назначение:** Маркетплейс
- **Товаров:** ~3
- **Статус:** Специальный

---

## Workflow менеджера

```
┌─────────────────────────────────────────────────────┐
│  1. Товар приходит из 1С                            │
│     ↓                                               │
│  products.id = 12345                                │
│     ↓                                               │
│  product_catalogs:                                  │
│    • product_id: 12345                              │
│    • catalog_id: X (Уровень-1С)                     │
│    • is_primary: TRUE                               │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  2. Менеджер обрабатывает                           │
│     - Проверяет описание                            │
│     - Добавляет фото                                │
│     - Назначает категории                           │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  3. Перемещает в Uroven.pro                         │
│     ↓                                               │
│  UPDATE: is_primary для старой категории            │
│  INSERT: новая категория Uroven.pro (is_primary)    │
│     ↓                                               │
│  product_catalogs:                                  │
│    • product_id: 12345, catalog_id: X, FALSE        │
│    • product_id: 12345, catalog_id: 826, TRUE ✓     │
└─────────────────┬───────────────────────────────────┘
                  │
┌─────────────────▼───────────────────────────────────┐
│  4. Товар готов к выгрузке                          │
│     - Основная категория: Uroven.pro                │
│     - Дополнительная: Уровень-1С (для истории)      │
│     - Breadcrumbs: "Uroven.pro > Инструмент > ..."  │
└─────────────────────────────────────────────────────┘
```

---

## SQL для UI

### Дерево каталогов для меню:

```sql
-- Корневые каталоги
SELECT * FROM v_root_catalogs;

-- Дети категории
SELECT * FROM catalogs WHERE parent_id = :id ORDER BY pos;

-- Вся ветка (подкатегории)
SELECT * FROM get_catalog_descendants(:id);
```

### Товары:

```sql
-- Товары категории
SELECT p.* FROM products p
JOIN product_catalogs pc ON p.id = pc.product_id
WHERE pc.catalog_id = :id;

-- Breadcrumbs товара
SELECT path FROM catalogs c
JOIN product_catalogs pc ON c.id = pc.catalog_id
WHERE pc.product_id = :id AND pc.is_primary = TRUE;
```

---

**Итого:**
- ✅ Простая структура (3 таблицы)
- ✅ Прямая связь по ID
- ✅ Быстрые запросы через Nested Sets
- ✅ Гибкость (товар в любых каталогах)
- ✅ Совместимость с PIM

🎯 **Готово к использованию!**

